<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SocioFlow | Full Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: { 
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#6366f1'
                    },
                    animation: {
                        'fade-in-down': 'fadeInDown 0.5s ease-out'
                    },
                    keyframes: {
                        fadeInDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        html { scroll-behavior: smooth; }
        
        body { 
            background-color: #0b1120; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: #cbd5e1;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .live-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.15);
            transition: all 0.3s ease;
        }
        .live-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.6);
        }

        /* Nav Dock Styles */
        .nav-dock {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 40;
            display: flex; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 9999px;
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .nav-item {
            color: #64748b; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease;
            position: relative; display: flex; align-items: center; justify-content: center;
        }
        .nav-item:hover { color: #e2e8f0; background: rgba(255, 255, 255, 0.05); transform: translateY(-3px); }
        .nav-item.active { color: #ffffff; background: linear-gradient(135deg, #4f46e5, #6366f1); box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
        
        .badge { display: inline-flex; align-items: center; padding: 0.25em 0.6em; font-size: 0.65rem; font-weight: 700; border-radius: 4px; letter-spacing: 0.05em; }
        .badge-active { color: #6ee7b7; background: rgba(5, 150, 105, 0.2); border: 1px solid rgba(5, 150, 105, 0.4); }
        .badge-inactive { color: #fca5a5; background: rgba(185, 28, 28, 0.2); border: 1px solid rgba(185, 28, 28, 0.4); }
        .badge-offline { color: #64748b; background: rgba(30, 41, 59, 0.5); border: 1px solid #475569; }
        
        .editable-input { background: #0f172a; border: 1px solid #334155; color: white; width: 100%; padding: 0.75rem; border-radius: 0.5rem; transition: all 0.2s; }
        .editable-input:disabled { background: transparent; border-color: transparent; padding-left: 0; font-weight: 700; color: #94a3b8; opacity: 1; cursor: not-allowed; }
        .editable-input:disabled option { display: none; }

        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
        .toast { pointer-events: auto; background: #1e293b; color: white; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #10b981; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; gap: 0.75rem; align-items: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .toast.show { transform: translateX(0); }
        
        .modal-sheet { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-sheet.open { display: flex; }
        .modal-content { background: #1e293b; width: 100%; max-width: 600px; border-radius: 1rem; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); transform: scale(0.95); opacity: 0; transition: all 0.3s ease-out; }
        .modal-sheet.open .modal-content { transform: scale(1); opacity: 1; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day { aspect-ratio: 1; display: flex; items-center; justify-content: center; border-radius: 4px; background-color: #334155; color: #cbd5e1; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .day.absent { background-color: rgba(225, 29, 72, 0.2); color: #f43f5e; border: 1px solid #f43f5e; font-weight: 800; }
    </style>
</head>
<body class="p-4 md:p-6 pb-24 font-sans">

    <div id="toast-container"></div>

    <div class="max-w-7xl mx-auto">
        <!-- HEADER -->
        <header id="seccion-inicio" class="mb-6 flex items-center justify-between border-b border-slate-800 pb-4">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <span class="w-10 h-10 rounded-lg bg-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                        <i class="fas fa-radar"></i>
                    </span>
                    <span class="absolute -top-1 -right-1 flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                    </span>
                </div>
                <div>
                    <h1 class="text-xl font-black text-white tracking-tight">SOCIO<span class="text-indigo-400">FLOW</span></h1>
                    <p class="text-[10px] text-slate-500 font-mono tracking-widest">CarlosPN Interactive® 2026</p>
                </div>
            </div>
            <div id="status-badge" class="flex items-center gap-2 bg-slate-900/50 px-3 py-1.5 rounded-full border border-slate-700">
                <span id="ping-static" class="w-2 h-2 rounded-full bg-slate-500"></span>
                <p class="text-[9px] font-bold text-slate-400 uppercase" id="last-update-text">OFFLINE</p>
            </div>
        </header>

        <!-- KPIS -->
        <section id="seccion-kpi" class="grid grid-cols-3 gap-3 mb-8 scroll-mt-24">
            <div class="glass-panel p-4 rounded-xl border-l-2 border-indigo-500">
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Total BD</p>
                <p id="total-users" class="text-2xl font-black text-white">0</p>
            </div>
            <div class="glass-panel p-4 rounded-xl border-l-2 border-emerald-500">
                <p class="text-[9px] font-bold text-emerald-400 uppercase tracking-widest">Activos Ahora</p>
                <p id="active-users" class="text-2xl font-black text-emerald-400">0</p>
            </div>
            <div class="glass-panel p-4 rounded-xl border-l-2 border-rose-500">
                <p class="text-[9px] font-bold text-rose-400 uppercase tracking-widest">Bloqueados</p>
                <p id="inactive-users" class="text-2xl font-black text-rose-400">0</p>
            </div>
        </section>

        <!-- SECCIÓN CRÍTICA: USUARIOS EN VIVO -->
        <section id="seccion-live" class="mb-8 scroll-mt-24">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-bold text-emerald-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-bolt animate-pulse"></i> Monitor de Sala (En Vivo)
                </h2>
                <span class="text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded border border-emerald-500/20 font-mono" id="live-count-badge">0 Conectados</span>
            </div>

            <div id="live-monitor-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full py-8 text-center border border-dashed border-slate-800 rounded-xl bg-slate-900/30">
                    <p class="text-slate-500 text-xs font-mono">Esperando conexiones...</p>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- RANKING -->
            <section id="seccion-ranking" class="glass-panel rounded-xl p-5 lg:col-span-1 h-fit scroll-mt-24">
                <h2 class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i class="fas fa-trophy"></i> Top Frecuentes
                </h2>
                <div id="ranking-list" class="space-y-3"></div>
            </section>

            <!-- BASE DE DATOS COMPLETA -->
            <section id="seccion-db" class="lg:col-span-2 space-y-4 scroll-mt-24">
                <div class="flex gap-2">
                    <input type="text" id="searchInput" placeholder="Buscar socio..." class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                    <select id="filterInput" class="bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">
                        <option value="all">Todos</option>
                        <option value="Inactivo">Bloqueados</option>
                    </select>
                </div>
                
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="overflow-x-auto max-h-[400px]">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-900/80 text-[10px] uppercase text-slate-500 font-bold sticky top-0 z-10 backdrop-blur-sm">
                                <tr>
                                    <th class="px-4 py-3">Socio</th>
                                    <th class="px-4 py-3 text-center">Estado</th>
                                    <th class="px-4 py-3 text-right">Bloquear</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- MENÚ FLOTANTE -->
    <nav class="nav-dock">
        <a href="#seccion-kpi" class="nav-item active"><i class="fas fa-chart-pie"></i></a>
        <a href="#seccion-live" class="nav-item"><i class="fas fa-satellite-dish"></i></a>
        <a href="#seccion-ranking" class="nav-item"><i class="fas fa-trophy"></i></a>
        <a href="#seccion-db" class="nav-item"><i class="fas fa-table"></i></a>
        <a href="#seccion-inicio" class="nav-item"><i class="fas fa-arrow-up"></i></a>
    </nav>

    <!-- MODAL PRINCIPAL -->
    <div id="userDetailsModal" class="modal-sheet">
        <div class="absolute inset-0 bg-black/80" id="modal-overlay"></div>
        <div class="modal-content relative">
            <div class="bg-slate-800/90 p-6 border-b border-slate-700 flex justify-between items-start sticky top-0 z-20 backdrop-blur-md">
                <div>
                    <h3 id="modal-header-display" class="text-xl font-black text-white">--</h3>
                    <p class="text-[10px] font-bold text-indigo-400 font-mono mt-1">ID: <span id="modal-id">--</span></p>
                </div>
                <div class="flex gap-2">
                    <button id="toggleEditBtn" class="w-10 h-10 rounded-xl bg-slate-700 hover:bg-indigo-600 text-white transition-colors flex items-center justify-center"><i class="fas fa-pen text-sm"></i></button>
                    <button id="closeModalBtn" class="w-10 h-10 rounded-xl bg-slate-700 hover:bg-rose-600 text-white transition-colors flex items-center justify-center"><i class="fas fa-times text-lg"></i></button>
                </div>
            </div>

            <div class="p-6 space-y-6" id="modal-form-container">
                
                <!-- NUEVO: SELECTOR DE ESTADO -->
                <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 flex items-center justify-between">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Estado de Cuenta</span>
                    <button id="modal-status-toggle" class="px-4 py-2 rounded-lg font-bold text-xs uppercase transition-colors bg-emerald-500/20 text-emerald-400 border border-emerald-500/50">
                        <i class="fas fa-check-circle mr-2"></i> Habilitado
                    </button>
                </div>

                <!-- SECCION PUNTOS -->
                <div class="bg-gradient-to-br from-indigo-900 to-violet-900 rounded-2xl p-5 text-white shadow-xl border border-indigo-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-bold uppercase opacity-80 tracking-widest">Puntos Disponibles</span>
                        <i class="fas fa-star text-amber-300"></i>
                    </div>
                    <div class="flex items-center justify-between">
                        <span id="modal-puntos-display" class="text-5xl font-black tracking-tighter">0</span>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 font-bold point-btn transition-colors" data-val="-10">-10</button>
                            <button class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 font-bold point-btn transition-colors" data-val="10">+10</button>
                            <button class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 font-bold point-btn transition-colors" data-val="-1">-1</button>
                            <button class="w-10 h-10 rounded-xl bg-white text-indigo-900 font-black point-btn hover:bg-indigo-50 transition-colors" data-val="1">+1</button>
                        </div>
                    </div>
                </div>

                <!-- SALDO Y AUSENCIAS -->
                <div class="grid grid-cols-2 gap-3">
                    <div id="openSaldoModalBtn" class="bg-slate-800 p-4 rounded-xl border border-slate-700 cursor-pointer hover:border-emerald-500 transition-colors group">
                        <p class="text-[9px] font-bold text-emerald-500 uppercase mb-1">Saldo Anterior</p>
                        <p id="modal-saldo-anterior" class="text-xl font-mono font-bold text-white group-hover:text-emerald-400 transition-colors">$0</p>
                    </div>
                    <div id="openAbsenceModalBtn" class="bg-slate-800 p-4 rounded-xl border border-slate-700 cursor-pointer hover:border-rose-500 transition-colors group">
                        <p class="text-[9px] font-bold text-rose-500 uppercase mb-1">Ausencias</p>
                        <p id="modal-dias-ausencia" class="text-xl font-mono font-bold text-white group-hover:text-rose-400 transition-colors">0 días</p>
                    </div>
                </div>

                <!-- FORMULARIO DE DATOS -->
                <div class="space-y-4 pt-2">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Nombre</label>
                            <input type="text" id="modal-nombre" class="editable-input" disabled>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Apellido</label>
                            <input type="text" id="modal-apellido" class="editable-input" disabled>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Teléfono</label>
                        <input type="text" id="modal-telefono" class="editable-input" disabled>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Sección</label>
                            <select id="modal-seccion" class="editable-input" disabled>
                                <option value="General">General</option>
                                <option value="Mesas">Mesas</option>
                                <option value="Máquinas">Máquinas</option>
                                <option value="Bóveda">Bóveda</option>
                                <option value="TGM">TGM</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Contrato</label>
                            <input type="text" id="modal-contrato" class="editable-input" disabled>
                        </div>
                    </div>
                    
                    <!-- FECHA DE INGRESO -->
                    <div class="pt-4 border-t border-slate-700/50">
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Fecha de Ingreso</label>
                        <div class="flex gap-2">
                            <input type="number" id="modal-dia" class="editable-input text-center w-16" placeholder="DD" disabled>
                            <select id="modal-mes" class="editable-input flex-1" disabled>
                                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option><option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option><option value="Agosto">Agosto</option><option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                            </select>
                            <input type="number" id="modal-anio" class="editable-input text-center w-20" placeholder="AAAA" disabled>
                        </div>
                    </div>
                </div>

                <button id="saveChangesBtn" class="hidden w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold shadow-lg transition-all transform active:scale-95 uppercase tracking-wide">Guardar Cambios</button>

                <div class="space-y-2 pt-2 border-t border-slate-700/50">
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase flex justify-between items-center">
                        <span>Historial de Accesos</span>
                        <span id="modal-total-visitas-badge" class="bg-indigo-900/50 text-indigo-300 px-2 py-0.5 rounded text-[9px] font-black border border-indigo-500/30">Total: 0</span>
                    </h4>
                    <ul id="modal-historial-lista" class="bg-black/20 rounded-xl divide-y divide-slate-700/50 border border-slate-700/50 overflow-hidden text-xs max-h-32 overflow-y-auto"></ul>
                </div>

                <button id="deleteUserBtn" class="w-full py-4 text-rose-500/70 hover:text-rose-500 font-bold text-[10px] uppercase border border-dashed border-rose-900/50 hover:border-rose-500 rounded-xl transition-all"><i class="fas fa-trash-alt mr-2"></i> Eliminar Socio Permanentemente</button>
            </div>
        </div>
    </div>

    <!-- MODALES AUXILIARES -->
    <div id="saldoModal" class="hidden fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-slate-800 rounded-2xl w-full max-w-xs p-8 space-y-6 border border-slate-700 shadow-2xl">
            <h3 class="font-black text-white text-center uppercase text-xs tracking-widest">Editar Saldo</h3>
            <div class="relative">
                <span class="absolute left-5 top-1/2 -translate-y-1/2 font-black text-slate-500 text-xl">$</span>
                <input type="number" id="saldoInput" class="w-full bg-slate-900 border border-slate-600 p-5 pl-10 rounded-2xl text-2xl font-mono font-black text-white outline-none focus:border-emerald-500 transition-colors">
            </div>
            <div class="flex gap-3">
                <button id="cancelSaldoBtn" class="flex-1 py-4 text-slate-400 hover:text-white font-bold text-sm transition-colors">Cerrar</button>
                <button id="saveSaldoBtn" class="flex-1 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl font-black text-sm transition-colors">Guardar</button>
            </div>
        </div>
    </div>

    <div id="absenceModal" class="hidden fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-[2rem] w-full max-w-md p-6 border border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-6 px-2">
                <button id="prevMonthBtn" class="w-12 h-12 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white rounded-2xl transition-colors"><i class="fas fa-chevron-left"></i></button>
                <h4 id="monthYear" class="font-black text-white capitalize text-lg"></h4>
                <button id="nextMonthBtn" class="w-12 h-12 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white rounded-2xl transition-colors"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid text-[9px] font-black text-slate-500 mb-2 uppercase text-center">
                <div>LU</div><div>MA</div><div>MI</div><div>JU</div><div>VI</div><div>SA</div><div>DO</div>
            </div>
            <div id="calendar-container" class="mb-6"></div>
            <div class="flex gap-3">
                <button id="cancelAbsenceBtn" class="flex-1 py-4 text-slate-400 hover:text-white font-bold text-sm transition-colors">Cerrar</button>
                <button id="saveAbsenceBtn" class="flex-1 py-4 bg-rose-600 hover:bg-rose-500 text-white rounded-2xl font-black text-sm uppercase transition-colors">Guardar Faltas</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCs74u0wnowFhgAbYM_EL11eEyOH4GivGzwg1v0ovMLW6QvwqOuL9HRhxmAwL9m8X6/exec';
        let state = { users: [], latestTimestamp: null, isFetching: false, currentUser: null, isEditing: false, calendarDate: new Date() };

        // Referencias UI
        const ui = {
            liveGrid: document.getElementById('live-monitor-grid'),
            liveCount: document.getElementById('live-count-badge'),
            tableBody: document.getElementById('users-table-body'),
            rankingList: document.getElementById('ranking-list'),
            searchInput: document.getElementById('searchInput'),
            filterInput: document.getElementById('filterInput'),
            counters: { total: document.getElementById('total-users'), active: document.getElementById('active-users'), inactive: document.getElementById('inactive-users') },
            statusText: document.getElementById('last-update-text'),
            pingStatic: document.getElementById('ping-static'),
            
            // Modal Elements
            modal: { 
                el: document.getElementById('userDetailsModal'), 
                id: document.getElementById('modal-id'), 
                statusBtn: document.getElementById('modal-status-toggle'),
                nombre: document.getElementById('modal-nombre'), 
                apellido: document.getElementById('modal-apellido'), 
                phone: document.getElementById('modal-telefono'), 
                section: document.getElementById('modal-seccion'), 
                contract: document.getElementById('modal-contrato'), 
                dia: document.getElementById('modal-dia'),
                mes: document.getElementById('modal-mes'),
                anio: document.getElementById('modal-anio'),
                puntos: document.getElementById('modal-puntos-display'), 
                saldo: document.getElementById('modal-saldo-anterior'), 
                ausencias: document.getElementById('modal-dias-ausencia'), 
                history: document.getElementById('modal-historial-lista'), 
                editBtn: document.getElementById('toggleEditBtn'), 
                saveBtn: document.getElementById('saveChangesBtn'), 
                closeBtn: document.getElementById('closeModalBtn'), 
                deleteBtn: document.getElementById('deleteUserBtn'), 
                header: document.getElementById('modal-header-display'), 
                badge: document.getElementById('modal-total-visitas-badge') 
            },
            
            saldoModal: { el: document.getElementById('saldoModal'), input: document.getElementById('saldoInput'), saveBtn: document.getElementById('saveSaldoBtn'), cancelBtn: document.getElementById('cancelSaldoBtn'), openBtn: document.getElementById('openSaldoModalBtn') },
            absenceModal: { el: document.getElementById('absenceModal'), calendarContainer: document.getElementById('calendar-container'), monthYear: document.getElementById('monthYear'), prevBtn: document.getElementById('prevMonthBtn'), nextBtn: document.getElementById('nextMonthBtn'), saveBtn: document.getElementById('saveAbsenceBtn'), cancelBtn: document.getElementById('cancelAbsenceBtn'), openBtn: document.getElementById('openAbsenceModalBtn') }
        };

        const safe = str => str ? String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])) : '';
        const parseDate = d => { const i = new Date(d); return isNaN(i) ? null : i; };
        const normalizarFecha = f => { if(!f)return null; const d=new Date(f); return isNaN(d.getTime())?f:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };

        // Scroll Spy
        const sections = document.querySelectorAll('section');
        const navItems = document.querySelectorAll('.nav-item');
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => { if (pageYOffset >= (section.offsetTop - 300)) current = section.getAttribute('id'); });
            navItems.forEach(item => { item.classList.remove('active'); if (item.getAttribute('href').includes(current)) item.classList.add('active'); });
            if(window.scrollY < 100) { navItems.forEach(i => i.classList.remove('active')); navItems[0].classList.add('active'); }
        });

        const fetchData = async () => {
            if(state.isFetching) return;
            state.isFetching = true;
            ui.pingStatic.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
            try {
                const response = await fetch(SCRIPT_URL + '?action=read&v=' + Date.now());
                const data = await response.json();
                state.users = data.filter(u => u["ID de Usuario"]).sort((a,b) => parseDate(b.Timestamp) - parseDate(a.Timestamp));
                
                if (state.users.length > 0) {
                    const newest = state.users[0];
                    if (state.latestTimestamp && newest.Timestamp !== state.latestTimestamp && parseDate(newest.Timestamp) > parseDate(state.latestTimestamp)) {
                        if(newest.Estado === 'Activo') showToast(newest);
                    }
                    state.latestTimestamp = newest.Timestamp;
                }

                renderAll();

                // SI EL MODAL ESTÁ ABIERTO, ACTUALIZAR DATOS EN VIVO
                if (ui.modal.el.classList.contains('open') && state.currentUser) {
                    const updatedUser = state.users.find(u => u['ID de Usuario'] === state.currentUser['ID de Usuario']);
                    if (updatedUser) refreshModalHistory(updatedUser);
                }

                ui.statusText.textContent = 'MONITOREANDO'; ui.statusText.className = 'text-[9px] font-bold text-emerald-400 uppercase'; ui.pingStatic.className = 'w-2 h-2 rounded-full bg-emerald-500';
            } catch(e) { ui.statusText.textContent = 'ERROR'; ui.pingStatic.className = 'w-2 h-2 rounded-full bg-rose-500'; } 
            finally { state.isFetching = false; }
        };

        const renderAll = () => { updateStats(); renderLiveMonitor(); renderTable(); renderRanking(); };

        const renderLiveMonitor = () => {
            const active = state.users.filter(u => u.Estado === 'Activo');
            ui.liveCount.textContent = `${active.length} Conectados`;
            ui.liveGrid.innerHTML = active.length === 0 ? `<div class="col-span-full py-8 text-center border border-dashed border-slate-800 rounded-xl bg-slate-900/30"><p class="text-slate-500 text-xs font-mono">Esperando conexiones...</p></div>` : '';
            active.forEach(u => {
                const lastSeen = parseDate(u.Timestamp);
                const timeStr = lastSeen ? lastSeen.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
                ui.liveGrid.innerHTML += `
                <div class="live-card p-4 rounded-xl flex items-center justify-between animate-fade-in-down group">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="openModalById('${u['ID de Usuario']}')">
                        <div class="relative"><div class="w-12 h-12 rounded-lg bg-indigo-900/50 flex items-center justify-center font-black text-indigo-300 border border-indigo-500/30">${u.Nombre[0]}${u.Apellido[0]}</div><div class="absolute -bottom-1 -right-1 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full animate-pulse"></div></div>
                        <div><h4 class="font-bold text-white text-sm leading-tight">${safe(u.Nombre)} ${safe(u.Apellido)}</h4><p class="text-[10px] text-emerald-400 font-mono mt-0.5"><i class="fas fa-clock text-[8px] mr-1"></i>${timeStr}</p><p class="text-[9px] text-slate-500 font-mono">ID: ${u['ID de Usuario']}</p></div>
                    </div>
                    <button class="btn-kick bg-rose-500/10 hover:bg-rose-600 hover:text-white text-rose-500 border border-rose-500/30 rounded-lg p-3 transition-all duration-200" title="Desconectar Socio" data-id="${u['ID de Usuario']}"><i class="fas fa-power-off text-sm"></i></button>
                </div>`;
            });
            document.querySelectorAll('.btn-kick').forEach(b => b.onclick = e => { e.stopPropagation(); kickUser(b); });
        };

        const renderRanking = () => {
            const sorted = [...state.users].sort((a,b) => (b.Historial?.length||0) - (a.Historial?.length||0)).slice(0, 5);
            ui.rankingList.innerHTML = '';
            sorted.forEach((u, i) => ui.rankingList.innerHTML += `<div class="flex justify-between items-center text-xs border-b border-slate-800 pb-2 last:border-0"><span class="text-slate-300"><span class="font-bold text-amber-600 mr-2">#${i+1}</span> ${safe(u.Nombre)} ${safe(u.Apellido)}</span><span class="font-mono text-slate-500">${u.Historial?.length||0}</span></div>`);
        };

        const renderTable = () => {
            const search = ui.searchInput.value.toLowerCase();
            const filter = ui.filterInput.value;
            const list = state.users.filter(u => {
                const s = (u.Nombre+u.Apellido+u['ID de Usuario']).toLowerCase().includes(search);
                const f = filter === 'all' || (filter === 'Inactivo' && u.Estado === 'Inactivo');
                return s && f;
            });
            ui.tableBody.innerHTML = list.map(u => {
                const blocked = u.Estado === 'Inactivo';
                return `<tr class="hover:bg-slate-800/50 cursor-pointer" data-id="${u['ID de Usuario']}">
                    <td class="px-4 py-3"><div class="font-bold text-slate-300 text-xs">${safe(u.Nombre)} ${safe(u.Apellido)}</div></td>
                    <td class="px-4 py-3 text-center"><span class="badge ${blocked?'badge-inactive':(u.Estado==='Activo'?'badge-active':'badge-offline')}">${blocked?'BLOQ':(u.Estado==='Activo'?'ACTIVO':'OFF')}</span></td>
                    <td class="px-4 py-3 text-right">
                        <button class="btn-status w-8 h-8 rounded-lg ${blocked?'bg-rose-500/20 text-rose-400 border border-rose-500/50':'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50'} flex items-center justify-center transition-all hover:scale-110" data-id="${u['ID de Usuario']}" data-status="${blocked?'Activo':'Inactivo'}" title="${blocked?'Desbloquear':'Bloquear Acceso'}">
                            <i class="fas ${blocked?'fa-lock':'fa-lock-open'} text-xs"></i>
                        </button>
                    </td>
                </tr>`
            }).join('');
        };

        const updateStats = () => {
            ui.counters.total.textContent = state.users.length;
            ui.counters.active.textContent = state.users.filter(u => u.Estado === 'Activo').length;
            ui.counters.inactive.textContent = state.users.filter(u => u.Estado === 'Inactivo').length;
        };

        const showToast = u => {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<div class="w-8 h-8 bg-emerald-500/20 rounded flex items-center justify-center text-emerald-400"><i class="fas fa-user-check"></i></div><div><p class="text-[9px] font-bold text-emerald-400 uppercase">NUEVA CONEXIÓN</p><p class="text-xs font-bold text-white">${safe(u.Nombre)} ha ingresado.</p></div>`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.classList.add('show'),100); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),500)},5000);
        };

        const toggleStatus = async btn => {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: btn.dataset.id, status: btn.dataset.status }) });
            fetchData();
        };

        const kickUser = async btn => {
            if(!confirm("¿CONFIRMAR DESCONEXIÓN FORZADA?")) return;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: btn.dataset.id, status: 'KICK' }) });
            fetchData();
        };

        // Event listener para tabla
        ui.tableBody.onclick = e => {
            const btn = e.target.closest('.btn-status');
            const row = e.target.closest('tr');
            if(btn) { e.stopPropagation(); toggleStatus(btn); } 
            else if(row) { const id = row.getAttribute('data-id'); openModalById(id); }
        };

        // FUNCIÓN MEJORADA: Refrescar historial dentro del modal
        const refreshModalHistory = (u) => {
            if (!u.Historial || !Array.isArray(u.Historial)) return;
            
            // ORDENAR HISTORIAL: Forzar que el más reciente esté arriba
            const sortedHistory = [...u.Historial]
                .map(h => new Date(h))
                .filter(d => !isNaN(d.getTime())) // Filtrar fechas inválidas
                .sort((a, b) => b - a); // Orden descendente (más nuevo a más viejo)

            ui.modal.badge.textContent = `Total: ${sortedHistory.length}`;
            ui.modal.history.innerHTML = sortedHistory.slice(0, 50).map(d => `
                <li class="flex justify-between py-2 px-2 hover:bg-slate-700/30">
                    <span class="font-medium">${d.toLocaleDateString('es-CL')}</span>
                    <span class="text-indigo-400 font-mono">${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} HRS</span>
                </li>
            `).join('');
        };

        // Modal Logic
        window.openModalById = id => {
            const u = state.users.find(x => x['ID de Usuario'] == id);
            if(!u) return;
            state.currentUser = u; state.isEditing = false;
            const m = ui.modal;
            
            m.header.textContent = `${u.Nombre} ${u.Apellido}`; m.id.textContent = u['ID de Usuario'];
            m.nombre.value = u.Nombre || ''; m.apellido.value = u.Apellido || ''; m.phone.value = u.Teléfono || '';
            m.section.value = u.Sección || 'General'; m.contract.value = u['Tipo de Contrato'] || '';
            m.dia.value = u['Día de Ingreso'] || ''; m.mes.value = u['Mes de Ingreso'] || 'Enero'; m.anio.value = u['Año de Ingreso'] || '';
            m.puntos.textContent = u.Puntos || 0; m.saldo.textContent = `$${(u.SaldoAnterior||0).toLocaleString('es-CL')}`; 
            m.ausencias.textContent = `${u.DiasAusencia?.length||0} días`;
            
            refreshModalHistory(u); // Cargar historial ordenado
            
            const isBlocked = u.Estado === 'Inactivo';
            m.statusBtn.className = isBlocked 
                ? 'px-4 py-2 rounded-lg font-bold text-xs uppercase transition-colors bg-rose-500/20 text-rose-400 border border-rose-500/50 hover:bg-rose-500/30' 
                : 'px-4 py-2 rounded-lg font-bold text-xs uppercase transition-colors bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 hover:bg-emerald-500/30';
            m.statusBtn.innerHTML = isBlocked ? '<i class="fas fa-ban mr-2"></i> Bloqueado' : '<i class="fas fa-check-circle mr-2"></i> Habilitado';
            
            m.statusBtn.onclick = async () => {
                m.statusBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: u['ID de Usuario'], status: isBlocked ? 'Activo' : 'Inactivo' }) });
                fetchData(); setTimeout(() => openModalById(u['ID de Usuario']), 500);
            };

            updateEditModeUI();
            m.el.classList.add('open');
        };

        const updateEditModeUI = () => {
            const fields = [ui.modal.nombre, ui.modal.apellido, ui.modal.phone, ui.modal.section, ui.modal.contract, ui.modal.dia, ui.modal.mes, ui.modal.anio];
            fields.forEach(f => f.disabled = !state.isEditing);
            ui.modal.saveBtn.classList.toggle('hidden', !state.isEditing);
            ui.modal.editBtn.className = state.isEditing ? 'w-10 h-10 rounded-xl bg-rose-600 text-white flex items-center justify-center' : 'w-10 h-10 rounded-xl bg-slate-700 hover:bg-indigo-600 text-white flex items-center justify-center';
        };

        ui.modal.editBtn.onclick = () => { state.isEditing = !state.isEditing; updateEditModeUI(); };
        ui.modal.closeBtn.onclick = () => ui.modal.el.classList.remove('open');
        document.getElementById('modal-overlay').onclick = () => ui.modal.el.classList.remove('open');
        
        ui.modal.saveBtn.onclick = async () => {
            const m = ui.modal; m.saveBtn.textContent = 'Guardando...';
            const payload = { 
                action: 'editUser', id: state.currentUser['ID de Usuario'], 
                nombre: m.nombre.value, apellido: m.apellido.value, telefono: m.phone.value, 
                seccion: m.section.value, contrato: m.contract.value,
                dia: m.dia.value, mes: m.mes.value, anio: m.anio.value
            };
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            state.isEditing = false; updateEditModeUI(); fetchData(); m.saveBtn.textContent = 'GUARDAR CAMBIOS';
        };

        ui.modal.deleteBtn.onclick = async () => { if(confirm("¿ELIMINAR SOCIO PERMANENTEMENTE?")) { await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'deleteUser',id:state.currentUser['ID de Usuario']})}); ui.modal.el.classList.remove('open'); fetchData(); }};

        document.querySelectorAll('.point-btn').forEach(b => b.onclick = async () => {
            const val = parseInt(b.dataset.val); ui.modal.puntos.textContent = parseInt(ui.modal.puntos.textContent) + val;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: state.currentUser['ID de Usuario'], amount: val }) });
        });

        ui.saldoModal.openBtn.onclick = () => { ui.saldoModal.input.value = state.currentUser.SaldoAnterior||0; ui.saldoModal.el.classList.remove('hidden'); };
        ui.saldoModal.cancelBtn.onclick = () => ui.saldoModal.el.classList.add('hidden');
        ui.saldoModal.saveBtn.onclick = async () => { const amount = parseFloat(ui.saldoModal.input.value); ui.saldoModal.saveBtn.textContent = '...'; await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateSaldo', id: state.currentUser['ID de Usuario'], amount }) }); ui.modal.saldo.textContent = `$${amount.toLocaleString('es-CL')}`; ui.saldoModal.el.classList.add('hidden'); ui.saldoModal.saveBtn.textContent = 'Guardar'; };

        ui.absenceModal.openBtn.onclick = () => { state.calendarDate = new Date(); renderCalendar(); ui.absenceModal.el.classList.remove('hidden'); };
        ui.absenceModal.cancelBtn.onclick = () => ui.absenceModal.el.classList.add('hidden');
        ui.absenceModal.saveBtn.onclick = async () => {
             const dates = Array.from(ui.absenceModal.calendarContainer.querySelectorAll('.day.absent')).map(d => d.dataset.date); ui.absenceModal.saveBtn.textContent = '...';
             await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateAbsences', id: state.currentUser['ID de Usuario'], dates }) });
             ui.modal.ausencias.textContent = `${dates.length} días`; ui.absenceModal.el.classList.add('hidden'); ui.absenceModal.saveBtn.textContent = 'Guardar Faltas';
        };
        
        function renderCalendar() {
            const y=state.calendarDate.getFullYear(), m=state.calendarDate.getMonth();
            ui.absenceModal.monthYear.textContent = `${["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][m]} ${y}`;
            const first=new Date(y,m,1).getDay(), last=new Date(y,m+1,0).getDate(), start=(first+6)%7;
            const marked = new Set((state.currentUser.DiasAusencia||[]).map(normalizarFecha));
            let h='<div class="calendar-grid">'; for(let i=0;i<start;i++)h+='<div></div>';
            for(let i=1;i<=last;i++){ const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; h+=`<div class="day ${marked.has(ds)?'absent':''}" data-date="${ds}">${i}</div>`; }
            ui.absenceModal.calendarContainer.innerHTML = h + '</div>';
            ui.absenceModal.calendarContainer.querySelectorAll('.day').forEach(d => d.onclick = () => d.classList.toggle('absent'));
        }
        ui.absenceModal.prevBtn.onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); };
        ui.absenceModal.nextBtn.onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); };

        ui.searchInput.oninput = renderTable;
        ui.filterInput.onchange = renderTable;
        
        fetchData(); setInterval(fetchData, 4000);
    });
    </script>
</body>
</html>