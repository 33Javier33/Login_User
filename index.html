<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión de Usuarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .badge { display: inline-flex; align-items: center; padding: 0.25em 0.7em; font-size: 0.75rem; font-weight: 700; border-radius: 9999px; line-height: 1; }
        .badge-active { color: #15803d; background-color: #dcfce7; border: 1px solid #bbf7d0; }
        .badge-inactive { color: #b91c1c; background-color: #fee2e2; border: 1px solid #fecaca; }
        .badge-offline { color: #475569; background-color: #f1f5f9; border: 1px solid #cbd5e1; }
        
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; }
        .btn-green { background-color: #22c55e; color: white; }
        .btn-red { background-color: #ef4444; color: white; }
        
        .editable-input { background: transparent; border: 1px solid transparent; width: 100%; padding: 4px 0; font-weight: 600; color: #334155; transition: all 0.2s; }
        .editable-input:disabled { background: transparent; opacity: 1; cursor: default; border-bottom: 1px dashed #e2e8f0; }
        
        /* Select específico deshabilitado */
        select.editable-input:disabled { -webkit-appearance: none; appearance: none; background-image: none; border-bottom: 1px dashed #e2e8f0; }

        .is-editing .editable-input { background: #ffffff; border: 1px solid #cbd5e1; padding: 4px 8px; border-radius: 6px; }
        .is-editing .editable-input:focus { border-color: #3b82f6; outline: 2px solid #bfdbfe; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .modal-open { opacity: 1; pointer-events: auto; }
        .modal-closed { opacity: 0; pointer-events: none; }
        
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
        .toast { pointer-events: auto; background: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 5px solid #3b82f6; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; gap: 1rem; align-items: center; }
        .toast.show { transform: translateX(0); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-name { font-weight: bold; color: #64748b; padding-bottom: 5px; font-size: 0.75rem; }
        .day { padding: 8px; border-radius: 9999px; background-color: #f1f5f9; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .day:hover { background-color: #e2e8f0; }
        .day.absent { background-color: #ef4444; color: #fff; font-weight: bold; border-color: #b91c1c; }
        .day.empty { background-color: transparent; cursor: default; }
    </style>
</head>
<body class="p-3 md:p-8 text-slate-800 pb-20">

    <div id="toast-container"></div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-users-cog text-blue-600"></i> Gestión de Socios
                </h1>
                <p class="text-slate-500 text-sm mt-1">Panel de Administración en Tiempo Real</p>
            </div>
            <div id="status-badge" class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-200 w-fit transition-colors duration-300">
                <span class="relative flex h-3 w-3">
                  <span id="ping-animate" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                  <span id="ping-static" class="relative inline-flex rounded-full h-3 w-3 bg-slate-500"></span>
                </span>
                <p class="text-xs font-medium text-slate-600" id="last-update-text">Conectando...</p>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200 grid grid-cols-3 divide-x divide-slate-100">
                <div class="text-center px-2"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total</p><p id="total-users" class="text-3xl font-bold text-slate-800 mt-1">0</p></div>
                <div class="text-center px-2"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Activos</p><p id="active-users" class="text-3xl font-bold text-green-600 mt-1">0</p></div>
                <div class="text-center px-2"><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Inactivos</p><p id="inactive-users" class="text-3xl font-bold text-red-600 mt-1">0</p></div>
            </div>
            
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4 border-b pb-2 border-slate-100">
                    <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Última Actividad</h2>
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">Tiempo Real</span>
                </div>
                <ul id="recent-activity-list" class="space-y-2 overflow-y-auto max-h-48 custom-scrollbar flex-1 pr-1">
                    <li class="text-center text-slate-400 text-xs py-8 flex flex-col items-center animate-pulse">
                        <i class="fas fa-circle-notch fa-spin mb-2 text-blue-400"></i>
                        Esperando datos...
                    </li>
                </ul>
            </div>
        </section>

        <div class="bg-white p-5 md:p-6 rounded-xl shadow-sm border border-slate-200">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
                <h2 class="text-lg font-bold text-slate-800">Directorio de Socios</h2>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <div class="relative">
                        <i class="fas fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 z-10"></i>
                        <select id="filterInput" class="pl-9 pr-8 py-2 border border-slate-200 rounded-lg w-full sm:w-40 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-slate-50 transition-all appearance-none cursor-pointer hover:bg-white">
                            <option value="all">Todos</option>
                            <option value="Activo">Activos</option>
                            <option value="Inactivo">Inactivos</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                    <div class="relative w-full sm:w-auto">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por nombre..." class="pl-10 pr-4 py-2 border border-slate-200 rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-slate-50 transition-all">
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg border border-slate-100">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                        <tr>
                            <th class="px-6 py-4 font-semibold">Usuario</th>
                            <th class="px-6 py-4 font-semibold">Estado</th>
                            <th class="px-6 py-4 font-semibold">Puntos</th>
                            <th class="px-6 py-4 text-center font-semibold">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="divide-y divide-slate-100">
                        <tr><td colspan="4" class="p-12 text-center text-slate-400 animate-pulse">Conectando con la base de datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL PRINCIPAL -->
    <div id="userDetailsModal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 z-50 modal-closed backdrop-blur-sm hidden transition-opacity duration-200">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg modal-content transform scale-95 transition-transform duration-200 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start p-6 border-b border-slate-100 bg-white rounded-t-2xl z-10 flex-shrink-0">
                <div>
                    <!-- Header dinámico -->
                    <h3 class="text-xl font-bold text-slate-900 leading-tight" id="modal-header-display">...</h3>
                    <p class="text-sm text-slate-500 mt-1">ID: <span id="modal-id" class="font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-700 font-bold">...</span></p>
                </div>
                <div class="flex gap-2"><button id="toggleEditBtn" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded-lg text-sm font-bold transition-colors flex items-center shadow-sm"><i class="fas fa-pen mr-1.5"></i> Editar</button><button id="closeModalBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-500 rounded-full w-9 h-9 flex items-center justify-center transition-colors"><i class="fas fa-times text-lg"></i></button></div>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1" id="modal-form-container">
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border border-yellow-100 mb-6 flex justify-between items-center shadow-sm">
                    <div><p class="text-[10px] font-bold text-yellow-600 uppercase mb-1 tracking-wider">Puntos Acumulados</p><div class="flex items-center gap-2"><i class="fas fa-trophy text-yellow-500 text-lg"></i><p id="modal-puntos-display" class="text-3xl font-bold text-slate-800">0</p></div></div>
                    <div class="flex gap-1.5"><button class="w-9 h-9 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 font-bold shadow-sm point-btn transition-all" data-val="-10">-10</button><button class="w-9 h-9 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 font-bold shadow-sm point-btn transition-all" data-val="-1">-1</button><button class="w-9 h-9 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-green-600 hover:border-green-200 hover:bg-green-50 font-bold shadow-sm point-btn transition-all" data-val="1">+1</button><button class="w-9 h-9 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-green-600 hover:border-green-200 hover:bg-green-50 font-bold shadow-sm point-btn transition-all" data-val="10">+10</button></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <label class="text-xs font-bold text-green-800 uppercase tracking-wide flex items-center gap-1.5">
                            <i class="fas fa-piggy-bank"></i> Saldo Mes Anterior
                        </label>
                        <div class="flex items-center justify-between mt-2">
                            <p id="modal-saldo-anterior" class="text-2xl font-bold text-slate-800">$0</p>
                            <button id="openSaldoModalBtn" class="text-green-600 hover:text-green-800 font-bold text-sm">Editar</button>
                        </div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                        <label class="text-xs font-bold text-red-800 uppercase tracking-wide flex items-center gap-1.5">
                            <i class="fas fa-calendar-times"></i> Días de Ausencia
                        </label>
                        <div class="flex items-center justify-between mt-2">
                            <p id="modal-dias-ausencia" class="text-2xl font-bold text-slate-800">0 días</p>
                            <button id="openAbsenceModalBtn" class="text-red-600 hover:text-red-800 font-bold text-sm">Gestionar</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-5 mb-6">
                    <!-- Inputs para Nombre y Apellido -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1">Nombre</label><input type="text" id="modal-nombre" class="editable-input" disabled></div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1">Apellido</label><input type="text" id="modal-apellido" class="editable-input" disabled></div>
                    </div>

                    <div class="space-y-1"><label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1"><i class="fas fa-phone-alt"></i> Teléfono</label><input type="text" id="modal-telefono" class="editable-input" disabled placeholder="Sin registrar"></div>
                    
                    <!-- Select para Sección -->
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1"><i class="fas fa-layer-group"></i> Sección</label>
                        <select id="modal-seccion" class="editable-input" disabled>
                            <option value="General">General</option>
                            <option value="Mesas">Mesas</option>
                            <option value="Máquinas">Máquinas</option>
                            <option value="Bóveda">Bóveda</option>
                            <option value="Técnicos">Técnicos</option>
                            <option value="TGM">TGM</option>
                        </select>
                    </div>
                    
                    <div class="space-y-1"><label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1"><i class="fas fa-file-contract"></i> Contrato</label><input type="text" id="modal-contrato" class="editable-input" disabled placeholder="No especificado"></div>
                    
                    <!-- Fecha de Ingreso Editable -->
                    <div class="pt-3 border-t border-slate-100">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-1 mb-2"><i class="far fa-calendar-alt"></i> Fecha de Ingreso</label>
                        <div class="flex gap-2">
                            <input type="number" id="modal-dia" class="editable-input text-center w-16" placeholder="DD" disabled>
                            <span class="text-slate-400 font-bold text-xl">/</span>
                            <select id="modal-mes" class="editable-input" disabled>
                                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option><option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option><option value="Agosto">Agosto</option><option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                            </select>
                            <span class="text-slate-400 font-bold text-xl">/</span>
                            <input type="number" id="modal-anio" class="editable-input text-center w-20" placeholder="AAAA" disabled>
                        </div>
                    </div>
                </div>
                <button id="saveChangesBtn" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-md hover:bg-blue-700 hidden transform transition-all active:scale-95 mb-6"><i class="fas fa-save mr-2"></i> Guardar Cambios</button>
                <div class="border-t border-slate-100 pt-5 mb-4">
                    <h4 id="modal-history-title" class="text-sm font-bold text-slate-700 mb-3 flex items-center justify-between">
                        <span class="flex items-center gap-2"><i class="fas fa-history text-slate-400"></i> Historial de Accesos</span>
                    </h4>
                    <div class="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                        <div class="grid grid-cols-2 px-4 py-2 bg-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200"><span>Fecha</span><span class="text-right">Hora</span></div>
                        <ul id="modal-historial-lista" class="divide-y divide-slate-100 text-sm bg-white max-h-40 overflow-y-auto custom-scrollbar"><li class="p-4 text-center text-slate-400 italic text-xs">Cargando...</li></ul>
                    </div>
                    <p class="text-center text-xs text-slate-400 mt-2 italic">Mostrando últimos 20 registros</p>
                </div>
                <div class="border-t border-red-100 bg-red-50/50 rounded-xl p-4 mt-6"><h4 class="text-xs font-bold text-red-400 uppercase mb-2">Zona de Peligro</h4><button id="deleteUserBtn" class="w-full border border-red-200 bg-white text-red-600 hover:bg-red-50 font-bold py-2.5 rounded-lg text-sm transition-all shadow-sm hover:shadow flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i> Eliminar Usuario Permanentemente</button></div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA EDITAR SALDO -->
    <div id="saldoModal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold text-slate-800">Editar Saldo Mes Anterior</h3>
            </div>
            <div class="p-6">
                <label for="saldoInput" class="text-sm font-medium text-slate-600">Nuevo Monto</label>
                <input type="number" id="saldoInput" class="mt-1 w-full border border-slate-300 rounded-lg p-3 text-lg" placeholder="0">
            </div>
            <div class="p-4 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button id="cancelSaldoBtn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="saveSaldoBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Saldo</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA GESTIONAR AUSENCIAS -->
    <div id="absenceModal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b">
                <h3 class="text-lg font-bold text-slate-800">Gestionar Ausencias</h3>
                <p class="text-sm text-slate-500">Haz clic en los días para marcarlos/desmarcarlos.</p>
            </div>
            <div class="p-6">
                <div id="calendar-header" class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-slate-100">&lt;</button>
                    <h4 id="monthYear" class="font-bold"></h4>
                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-slate-100">&gt;</button>
                </div>
                <div id="calendar-container"></div>
            </div>
            <div class="p-4 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button id="cancelAbsenceBtn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="saveAbsenceBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Ausencias</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCs74u0wnowFhgAbYM_EL11eEyOH4GivGzwg1v0ovMLW6QvwqOuL9HRhxmAwL9m8X6/exec';

        // --- ESTADO Y UI ---
        let state = { users: [], latestTimestamp: null, isFetching: false, currentUser: null, isEditing: false, calendarDate: new Date() };
        const ui = {
            tableBody: document.getElementById('users-table-body'),
            modal: {
                el: document.getElementById('userDetailsModal'), content: document.querySelector('#userDetailsModal .modal-content'), container: document.getElementById('modal-form-container'),
                headerDisplay: document.getElementById('modal-header-display'), id: document.getElementById('modal-id'),
                nombre: document.getElementById('modal-nombre'), apellido: document.getElementById('modal-apellido'),
                phone: document.getElementById('modal-telefono'),
                section: document.getElementById('modal-seccion'), contract: document.getElementById('modal-contrato'), 
                dia: document.getElementById('modal-dia'), mes: document.getElementById('modal-mes'), anio: document.getElementById('modal-anio'),
                points: document.getElementById('modal-puntos-display'), 
                history: document.getElementById('modal-historial-lista'), historyTitle: document.getElementById('modal-history-title'),
                editBtn: document.getElementById('toggleEditBtn'), saveBtn: document.getElementById('saveChangesBtn'), closeBtn: document.getElementById('closeModalBtn'),
                deleteBtn: document.getElementById('deleteUserBtn'),
                saldo: document.getElementById('modal-saldo-anterior'),
                ausencias: document.getElementById('modal-dias-ausencia'),
            },
            searchInput: document.getElementById('searchInput'),
            filterInput: document.getElementById('filterInput'),
            counters: { total: document.getElementById('total-users'), active: document.getElementById('active-users'), inactive: document.getElementById('inactive-users') },
            activityList: document.getElementById('recent-activity-list'),
            toastContainer: document.getElementById('toast-container'),
            statusText: document.getElementById('last-update-text'),
            statusBadge: document.getElementById('status-badge'),
            pingAnimate: document.getElementById('ping-animate'),
            pingStatic: document.getElementById('ping-static'),
            saldoModal: {
                el: document.getElementById('saldoModal'),
                input: document.getElementById('saldoInput'),
                saveBtn: document.getElementById('saveSaldoBtn'),
                cancelBtn: document.getElementById('cancelSaldoBtn'),
                openBtn: document.getElementById('openSaldoModalBtn')
            },
            absenceModal: {
                el: document.getElementById('absenceModal'),
                calendarContainer: document.getElementById('calendar-container'),
                monthYear: document.getElementById('monthYear'),
                prevBtn: document.getElementById('prevMonthBtn'),
                nextBtn: document.getElementById('nextMonthBtn'),
                saveBtn: document.getElementById('saveAbsenceBtn'),
                cancelBtn: document.getElementById('cancelAbsenceBtn'),
                openBtn: document.getElementById('openAbsenceModalBtn')
            }
        };

        const safe = str => str ? String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])) : '';
        const parseDate = d => { const i = new Date(d); return isNaN(i) ? null : i; };
        const timeAgo = d => { if(!d)return'';const s=Math.floor((new Date()-d)/1000);return s<60?'ahora':s<3600?`${Math.floor(s/60)} min`:`${Math.floor(s/3600)} h`; };
        
        // [NUEVO] Función para normalizar fechas al formato AAAA-MM-DD
        function normalizarFecha(fechaInput) {
            if (!fechaInput) return null;
            if (typeof fechaInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fechaInput)) {
                return fechaInput;
            }
            const d = new Date(fechaInput);
            if (isNaN(d.getTime())) return fechaInput; 
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const setStatus = (status) => {
            if(status === 'loading') { ui.statusText.textContent = 'Actualizando...'; ui.pingStatic.className = 'relative inline-flex rounded-full h-3 w-3 bg-yellow-500'; } 
            else if(status === 'success') { ui.statusText.textContent = 'En línea'; ui.statusText.className = 'text-xs font-bold text-green-700'; ui.statusBadge.className = 'flex items-center gap-2 bg-green-50 px-3 py-1.5 rounded-full shadow-sm border border-green-200 w-fit'; ui.pingStatic.className = 'relative inline-flex rounded-full h-3 w-3 bg-green-500'; ui.pingAnimate.className = 'animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75'; } 
            else { ui.statusText.textContent = 'Sin conexión'; ui.statusText.className = 'text-xs font-bold text-red-700'; ui.statusBadge.className = 'flex items-center gap-2 bg-red-50 px-3 py-1.5 rounded-full shadow-sm border border-red-200 w-fit'; ui.pingStatic.className = 'relative inline-flex rounded-full h-3 w-3 bg-red-500'; ui.pingAnimate.className = 'hidden'; }
        };

        const fetchData = async () => {
            if(state.isFetching) return;
            state.isFetching = true;
            setStatus('loading');
            try {
                const response = await fetch(SCRIPT_URL + '?action=read&v=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error("La respuesta del servidor no es una lista de usuarios válida.");
                }

                state.users = data.filter(u => u["ID de Usuario"]).sort((a,b) => parseDate(b.Timestamp) - parseDate(a.Timestamp));
                
                if (state.users.length > 0) {
                    const newest = state.users[0];
                    if (state.latestTimestamp && newest.Timestamp !== state.latestTimestamp && parseDate(newest.Timestamp) > parseDate(state.latestTimestamp)) {
                        if(newest.Estado === 'Activo') {
                           showToast(newest);
                        }
                    }
                    state.latestTimestamp = newest.Timestamp;
                }
                renderTable();
                updateCounters();
                renderActivity();
                if(state.currentUser) {
                    const fresh = state.users.find(u => u['ID de Usuario'] == state.currentUser['ID de Usuario']);
                    if(fresh) {
                        state.currentUser = fresh;
                        if(!state.isEditing) {
                            ui.modal.points.textContent = fresh.Puntos || 0;
                            ui.modal.headerDisplay.textContent = `${fresh.Nombre} ${fresh.Apellido}`; 
                        }
                        ui.modal.saldo.textContent = `$${(fresh.SaldoAnterior || 0).toLocaleString('es-CL')}`;
                        const absenceCount = Array.isArray(fresh.DiasAusencia) ? fresh.DiasAusencia.length : 0;
                        ui.modal.ausencias.textContent = `${absenceCount} día${absenceCount !== 1 ? 's' : ''}`;
                    }
                }
                setStatus('success');
            } catch(e) {
                console.error("Error en fetchData:", e);
                setStatus('error');
                ui.tableBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-500 bg-red-50">Error de conexión o datos inválidos. Revisa la consola.</td></tr>`;
            } finally {
                state.isFetching = false;
            }
        };

        const kickUser = async (btn) => {
            const id = btn.dataset.id;
            if(!confirm("¿Cerrar la sesión de este usuario?")) return;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id, status: 'KICK' }) });
                showToast({Nombre: "Sesión", Apellido: "Cerrando..."}, 'success');
                fetchData(); 
            } catch(e) {
                alert('Error: ' + e.message);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        const renderActivity = () => {
            ui.activityList.innerHTML = '';
            if (state.users.length === 0) {
                ui.activityList.innerHTML = `<li class="text-center text-slate-400 text-xs py-8">Sin actividad reciente</li>`;
                return;
            }
            state.users.slice(0, 6).forEach(u => {
                const initials = (safe(u.Nombre ? u.Nombre[0] : '') + safe(u.Apellido ? u.Apellido[0] : '')).toUpperCase();
                const lastSeen = parseDate(u.Timestamp);
                const minutesAgo = lastSeen ? (new Date() - lastSeen) / 1000 / 60 : Infinity;
                let statusTextHtml = '';
                let statusDotClass = '';
                let showKickButton = false;
                if (u.Estado === 'Inactivo') {
                    statusTextHtml = `<span class="text-red-600 font-semibold">Bloqueado</span>`;
                    statusDotClass = 'bg-red-500';
                } else if (u.Estado === 'KICK') {
                    statusTextHtml = `<span class="text-yellow-600 font-bold italic">Cerrando...</span>`;
                    statusDotClass = 'bg-yellow-400 animate-pulse';
                } else if (u.Estado === 'Activo') {
                    if (minutesAgo < 12) {
                        statusTextHtml = `<span class="text-green-600 font-bold">En Línea</span>`;
                        statusDotClass = 'bg-green-500 animate-pulse';
                        showKickButton = true;
                    } else {
                        statusTextHtml = `<span class="text-orange-500 font-semibold">Ausente / Sin cerrar</span>`;
                        statusDotClass = 'bg-orange-400';
                        showKickButton = true;
                    }
                } else {
                    statusTextHtml = `<span class="text-slate-400 font-semibold">Desconectado</span>`;
                    statusDotClass = 'bg-slate-300';
                }
                const kickBtnHtml = showKickButton ? `<button class="btn-kick ml-2 text-slate-400 hover:text-red-600 transition-colors p-2 rounded-full hover:bg-red-50" title="Cerrar sesión" data-id="${u['ID de Usuario']}"><i class="fas fa-power-off"></i></button>` : '';
                ui.activityList.innerHTML += `<li class="relative flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-all duration-200 group cursor-default"><div class="relative flex-shrink-0"><div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-xs border border-slate-200 group-hover:border-blue-200 group-hover:bg-blue-50 transition-colors">${initials}</div><span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${statusDotClass}"></span></div><div class="flex-1 min-w-0"><p class="text-sm font-bold text-slate-800 truncate">${safe(u.Nombre)} ${safe(u.Apellido)}</p><p class="text-[11px] text-slate-500 truncate">${statusTextHtml}</p></div><div class="flex items-center gap-1"><div class="text-[10px] font-medium text-slate-400 whitespace-nowrap bg-slate-50 px-2 py-1 rounded">${timeAgo(lastSeen)}</div>${kickBtnHtml}</div></li>`;
            });
            document.querySelectorAll('.btn-kick').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); kickUser(btn); });
            });
        };

        const renderTable = () => {
            const searchTerm = ui.searchInput.value.toLowerCase();
            const filterStatus = ui.filterInput.value;
            const list = state.users.filter(u => {
                const matchesSearch = ((u.Nombre || '') + (u.Apellido || '')).toLowerCase().includes(searchTerm);
                const isConsideredActive = u.Estado !== 'Inactivo';
                const matchesStatus = filterStatus === 'all' || (filterStatus === 'Activo' && isConsideredActive) || (filterStatus === 'Inactivo' && !isConsideredActive);
                return matchesSearch && matchesStatus;
            });
            ui.tableBody.innerHTML = list.length ? '' : '<tr><td colspan="4" class="p-8 text-center text-slate-400">Sin resultados</td></tr>';
            list.forEach(u => {
                const isBlocked = u.Estado === 'Inactivo';
                const isOffline = u.Estado === 'Desconectado' || u.Estado === 'KICK';
                let badgeClass = 'badge-active'; let badgeText = 'Permitido'; let badgeIcon = '<i class="fas fa-check mr-1.5"></i>';
                let actionBtn = `<button class="btn btn-red text-xs btn-status shadow-sm hover:shadow-md" data-id="${u['ID de Usuario']}" data-status="Inactivo">Bloquear</button>`;
                if (isBlocked) {
                    badgeClass = 'badge-inactive'; badgeText = 'Bloqueado'; badgeIcon = '<i class="fas fa-ban mr-1.5"></i>';
                    actionBtn = `<button class="btn btn-green text-xs btn-status shadow-sm hover:shadow-md" data-id="${u['ID de Usuario']}" data-status="Activo">Desbloquear</button>`;
                } else if (isOffline) {
                    badgeClass = 'badge-offline'; badgeText = 'Desconectado'; badgeIcon = '<i class="fas fa-power-off mr-1.5"></i>';
                }
                ui.tableBody.innerHTML += `<tr class="bg-white hover:bg-slate-50 border-b cursor-pointer tr-user transition-colors group" data-id="${u['ID de Usuario']}"><td class="px-6 py-4 flex gap-3 font-medium text-slate-900 items-center"><div class="w-8 h-8 rounded-full bg-slate-200 group-hover:bg-blue-100 group-hover:text-blue-600 text-xs font-bold text-slate-500 flex items-center justify-center">${safe(u.Nombre ? u.Nombre[0] : '?')}${safe(u.Apellido ? u.Apellido[0] : '?')}</div>${safe(u.Nombre)} ${safe(u.Apellido)}</td><td class="px-6 py-4"><span class="badge ${badgeClass}">${badgeIcon}${badgeText}</span></td><td class="px-6 py-4 font-bold text-yellow-600"><div class="flex items-center gap-1"><i class="fas fa-star text-xs text-yellow-400"></i>${u.Puntos||0}</div></td><td class="px-6 py-4 text-center">${actionBtn}</td></tr>`;
            });
        };

        const updateCounters = () => { const active = state.users.filter(u=>u.Estado!=='Inactivo').length; ui.counters.total.textContent = state.users.length; ui.counters.active.textContent = active; ui.counters.inactive.textContent = state.users.length - active; };
        
        const showToast = (msg, type = 'info') => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'error' ? '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>' : (msg.Nombre ? '<i class="fas fa-user-check text-green-500 text-xl"></i>' : '<i class="fas fa-check-circle text-green-500 text-xl"></i>');
            const title = msg.Nombre ? 'Nuevo Ingreso' : (type === 'error' ? 'Error' : 'Éxito');
            const text = msg.Nombre ? `${msg.Nombre} ${msg.Apellido}` : msg;
            toast.innerHTML = `${icon}<div><h4 class="font-bold text-sm text-slate-800">${title}</h4><p class="text-xs text-slate-500">${text}</p></div>`;
            ui.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
        };

        const updatePoints = async (amount) => {
            if (!state.currentUser) return;
            const originalPoints = parseInt(ui.modal.points.textContent);
            ui.modal.points.textContent = originalPoints + amount;
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updatePoints', id: state.currentUser['ID de Usuario'], amount: amount })
                });
                state.currentUser.Puntos = originalPoints + amount;
            } catch (e) {
                ui.modal.points.textContent = originalPoints;
                showToast('Error al actualizar puntos', 'error');
            }
        };

        const toggleStatus = async (btn) => {
            const id = btn.dataset.id;
            const newStatus = btn.dataset.status;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id, status: newStatus }) });
                showToast('Estado actualizado', 'success');
                fetchData();
            } catch(e) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('Error de conexión', 'error');
            }
        };

        const deleteUser = async () => {
            if(!confirm("ADVERTENCIA: ¿Estás seguro de eliminar este usuario permanentemente? Esta acción no se puede deshacer.")) return;
            ui.modal.deleteBtn.disabled = true;
            ui.modal.deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Eliminando...';
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteUser', id: state.currentUser['ID de Usuario'] }) });
                showToast('Usuario eliminado', 'success');
                closeModal();
                fetchData();
            } catch(e) {
                ui.modal.deleteBtn.disabled = false;
                ui.modal.deleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Eliminar Usuario Permanentemente';
                alert('Error al eliminar');
            }
        };
        
        const openModal = (user) => {
            state.currentUser = user;
            state.isEditing = false;
            updateEditModeUI();
            const m = ui.modal;
            
            m.headerDisplay.textContent = `${user.Nombre} ${user.Apellido}`;
            m.nombre.value = user.Nombre || '';
            m.apellido.value = user.Apellido || '';
            m.id.textContent = user['ID de Usuario'];
            m.phone.value = user.Teléfono || '';
            m.section.value = user.Sección || 'General';
            m.contract.value = user['Tipo de Contrato'] || '';
            m.points.textContent = user.Puntos || 0;
            
            m.dia.value = user['Día de Ingreso'] || '';
            m.mes.value = user['Mes de Ingreso'] || 'Enero';
            m.anio.value = user['Año de Ingreso'] || '';
            
            m.saldo.textContent = `$${(user.SaldoAnterior || 0).toLocaleString('es-CL')}`;
            const absenceCount = Array.isArray(user.DiasAusencia) ? user.DiasAusencia.length : 0;
            m.ausencias.textContent = `${absenceCount} día${absenceCount !== 1 ? 's' : ''}`;

            const totalVisitas = user.Historial ? user.Historial.length : 0;
            m.historyTitle.innerHTML = `<span class="flex items-center gap-2"><i class="fas fa-history text-slate-400"></i> Historial de Accesos</span> <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full font-bold">Total: ${totalVisitas}</span>`;

            m.history.innerHTML = '';
            if(user.Historial && user.Historial.length){
                user.Historial.slice(0, 20).forEach(h => {
                    const d = new Date(h);
                    const fechaStr = d.toLocaleDateString('es-CL', {day:'2-digit', month:'2-digit', year:'numeric'});
                    const horaStr = d.toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                    m.history.innerHTML += `<li class="px-4 py-3 flex justify-between items-center hover:bg-slate-50 border-b border-slate-50 last:border-0"><span class="text-slate-700 font-medium text-sm">${fechaStr}</span><span class="font-mono text-slate-500 text-xs bg-slate-100 px-2 py-1 rounded">${horaStr} hrs</span></li>`;
                });
            } else {
                m.history.innerHTML = '<li class="p-8 text-center text-slate-400 text-sm">Sin historial</li>';
            }
            m.el.classList.remove('hidden', 'modal-closed');
            m.el.classList.add('modal-open');
            m.content.classList.remove('scale-95');
        };

        const closeModal = () => { ui.modal.el.classList.add('modal-closed'); ui.modal.content.classList.add('scale-95'); setTimeout(() => ui.modal.el.classList.add('hidden'), 200); state.currentUser = null; };
        
        const toggleEditMode = () => { 
            state.isEditing = !state.isEditing; 
            updateEditModeUI(); 
        };

        const updateEditModeUI = () => {
            const m = ui.modal;
            const fields = [m.nombre, m.apellido, m.phone, m.section, m.contract, m.dia, m.mes, m.anio];
            
            if(state.isEditing) {
                m.container.classList.add('is-editing');
                fields.forEach(el => el.disabled = false);
                m.saveBtn.classList.remove('hidden');
                m.editBtn.innerHTML = '<i class="fas fa-times mr-1.5"></i> Cancelar';
                m.editBtn.className = 'bg-red-50 text-red-600 hover:bg-red-100 px-3 py-2 rounded-lg text-sm font-bold transition-colors flex items-center shadow-sm';
            } else {
                m.container.classList.remove('is-editing');
                fields.forEach(el => el.disabled = true);
                m.saveBtn.classList.add('hidden');
                m.editBtn.innerHTML = '<i class="fas fa-pen mr-1.5"></i> Editar';
                m.editBtn.className = 'bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded-lg text-sm font-bold transition-colors flex items-center shadow-sm';
                
                if(state.currentUser) {
                    m.nombre.value = state.currentUser.Nombre || '';
                    m.apellido.value = state.currentUser.Apellido || '';
                    m.section.value = state.currentUser.Sección || 'General';
                    m.dia.value = state.currentUser['Día de Ingreso'] || '';
                    m.mes.value = state.currentUser['Mes de Ingreso'] || 'Enero';
                    m.anio.value = state.currentUser['Año de Ingreso'] || '';
                }
            }
        };

        const saveUserChanges = async () => {
            if(!state.currentUser) return;
            const m = ui.modal;
            m.saveBtn.disabled = true;
            m.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

            const payload = {
                action: 'editUser',
                id: state.currentUser['ID de Usuario'],
                nombre: m.nombre.value,
                apellido: m.apellido.value,
                telefono: m.phone.value,
                seccion: m.section.value,
                contrato: m.contract.value,
                dia: m.dia.value,
                mes: m.mes.value,
                anio: m.anio.value
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                
                state.currentUser.Nombre = payload.nombre;
                state.currentUser.Apellido = payload.apellido;
                state.currentUser.Teléfono = payload.telefono;
                state.currentUser.Sección = payload.seccion;
                state.currentUser['Tipo de Contrato'] = payload.contrato;
                state.currentUser['Día de Ingreso'] = payload.dia;
                state.currentUser['Mes de Ingreso'] = payload.mes;
                state.currentUser['Año de Ingreso'] = payload.anio;
                
                m.headerDisplay.textContent = `${payload.nombre} ${payload.apellido}`;
                showToast('Cambios guardados', 'success');
                toggleEditMode();
                fetchData(); 
            } catch(e) {
                alert('Error al guardar: ' + e.message);
            } finally {
                m.saveBtn.disabled = false;
                m.saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Cambios';
            }
        };

        // Lógica para el modal de Saldo
        ui.saldoModal.openBtn.addEventListener('click', () => {
            if (!state.currentUser) return;
            ui.saldoModal.input.value = state.currentUser.SaldoAnterior || 0;
            ui.saldoModal.el.classList.remove('hidden');
        });
        ui.saldoModal.cancelBtn.addEventListener('click', () => ui.saldoModal.el.classList.add('hidden'));
        ui.saldoModal.saveBtn.addEventListener('click', async () => {
            const amount = parseFloat(ui.saldoModal.input.value);
            if (isNaN(amount)) return;
            const btn = ui.saldoModal.saveBtn;
            btn.disabled = true; btn.textContent = 'Guardando...';
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateSaldo', id: state.currentUser['ID de Usuario'], amount: amount })
                });
                state.currentUser.SaldoAnterior = amount;
                ui.modal.saldo.textContent = `$${amount.toLocaleString('es-CL')}`;
                showToast('Saldo actualizado', 'success');
                ui.saldoModal.el.classList.add('hidden');
            } catch (e) {
                showToast('Error al guardar', 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Guardar Saldo';
            }
        });

        // Lógica para el modal de Ausencias
        ui.absenceModal.openBtn.addEventListener('click', () => {
            if (!state.currentUser) return;
            state.calendarDate = new Date();
            renderAbsenceCalendar();
            ui.absenceModal.el.classList.remove('hidden');
        });
        ui.absenceModal.cancelBtn.addEventListener('click', () => ui.absenceModal.el.classList.add('hidden'));
        ui.absenceModal.prevBtn.addEventListener('click', () => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
            renderAbsenceCalendar();
        });
        ui.absenceModal.nextBtn.addEventListener('click', () => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
            renderAbsenceCalendar();
        });
        ui.absenceModal.saveBtn.addEventListener('click', async () => {
            const markedDays = Array.from(ui.absenceModal.calendarContainer.querySelectorAll('.day.absent')).map(d => d.dataset.date);
            const btn = ui.absenceModal.saveBtn;
            btn.disabled = true; btn.textContent = 'Guardando...';
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateAbsences', id: state.currentUser['ID de Usuario'], dates: markedDays })
                });
                state.currentUser.DiasAusencia = markedDays;
                ui.modal.ausencias.textContent = `${markedDays.length} día${markedDays.length !== 1 ? 's' : ''}`;
                showToast('Ausencias actualizadas', 'success');
                ui.absenceModal.el.classList.add('hidden');
            } catch (e) {
                showToast('Error al guardar', 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Guardar Ausencias';
            }
        });
        
        function renderAbsenceCalendar() {
            const year = state.calendarDate.getFullYear();
            const month = state.calendarDate.getMonth();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            ui.absenceModal.monthYear.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = (firstDay.getDay() + 6) % 7;
            
            let html = '<div class="calendar-grid">';
            ["Lu", "Ma", "Mi", "Ju", "Vi", "Sa", "Do"].forEach(d => html += `<div class="day-name">${d}</div>`);
            for (let i = 0; i < startingDay; i++) html += `<div class="day empty"></div>`;
            
            // [CORREGIDO] Normalización de fechas para el Set
            const markedDays = new Set((state.currentUser.DiasAusencia || []).map(normalizarFecha));

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                // [CORREGIDO] Chequeo usando la misma normalización
                const isMarked = markedDays.has(dateStr);
                html += `<div class="day ${isMarked ? 'absent' : ''}" data-date="${dateStr}">${i}</div>`;
            }
            html += `</div>`;
            ui.absenceModal.calendarContainer.innerHTML = html;

            // [CORREGIDO] Toggle robusto (quitar y poner)
            ui.absenceModal.calendarContainer.querySelectorAll('.day:not(.empty)').forEach(dayEl => {
                dayEl.addEventListener('click', () => {
                    if (dayEl.classList.contains('absent')) {
                        dayEl.classList.remove('absent');
                    } else {
                        dayEl.classList.add('absent');
                    }
                });
            });
        }

        const notificarCierre = () => { /* ... */ };
        window.addEventListener('pagehide', notificarCierre);

        ui.modal.nombre.addEventListener('input', () => {
            ui.modal.headerDisplay.textContent = `${ui.modal.nombre.value} ${ui.modal.apellido.value}`;
        });
        ui.modal.apellido.addEventListener('input', () => {
            ui.modal.headerDisplay.textContent = `${ui.modal.nombre.value} ${ui.modal.apellido.value}`;
        });

        ui.searchInput.addEventListener('input', () => setTimeout(renderTable, 300));
        ui.filterInput.addEventListener('change', renderTable);
        ui.tableBody.addEventListener('click', e => {
            e.stopPropagation();
            if(e.target.closest('.btn-status')) {
                toggleStatus(e.target.closest('.btn-status'));
            } else if(e.target.closest('.tr-user')) {
                const user = state.users.find(u => u['ID de Usuario'] == e.target.closest('.tr-user').dataset.id);
                if(user) openModal(user);
            }
        });
        ui.modal.closeBtn.addEventListener('click', closeModal);
        ui.modal.editBtn.addEventListener('click', toggleEditMode);
        ui.modal.saveBtn.addEventListener('click', saveUserChanges);
        ui.modal.deleteBtn.addEventListener('click', deleteUser);
        document.querySelectorAll('.point-btn').forEach(btn => btn.addEventListener('click', () => updatePoints(parseInt(btn.dataset.val))));

        fetchData(); 
        setInterval(fetchData, 10000);
    });
    </script>
</body>
</html>