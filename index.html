<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SocioComision Premium | Sincronización Total</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --bg-main: #020617;
            --bg-card: #0f172a;
            --primary: #6366f1;
            --emerald: #10b981;
        }

        body {
            background-color: var(--bg-main);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: #111827;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.25rem;
        }

        /* TOASTS (NOTIFICACIONES) */
        #toast-container {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 9999; pointer-events: none;
        }
        .toast {
            background: #1e293b; color: white; padding: 1rem; border-radius: 1rem;
            margin-bottom: 0.5rem; border-left: 6px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: flex; align-items: center; 
            gap: 0.75rem; animation: toastIn 0.3s ease-out forwards; pointer-events: auto;
        }
        @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast.hide { animation: toastOut 0.3s ease-in forwards; }

        /* INPUTS ALTO CONTRASTE */
        .editable-input {
            background: #1e293b !important;
            border: 2px solid #334155 !important;
            color: #ffffff !important;
            width: 100%; padding: 0.85rem; border-radius: 0.75rem;
            font-size: 16px; font-weight: 600;
        }
        .editable-input:disabled {
            background: transparent !important; border-color: transparent !important;
            color: #f1f5f9 !important; font-weight: 800; opacity: 1; -webkit-text-fill-color: #f1f5f9;
        }

        .label-style { color: #818cf8; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 0.3rem; display: block; }

        /* MODAL BOTTOM SHEET */
        .modal-sheet { position: fixed; inset: 0; z-index: 100; display: none; align-items: flex-end; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .modal-sheet.open { display: flex; }
        .modal-content {
            background: #0f172a; width: 100%; border-radius: 2rem 2rem 0 0;
            max-height: 94vh; overflow-y: auto; border-top: 2px solid var(--primary);
            transform: translateY(100%); transition: transform 0.4s ease-out;
            padding-bottom: 80px;
        }
        .modal-sheet.open .modal-content { transform: translateY(0); }

        .nav-dock { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; background: #1e293b; border-radius: 1.5rem; display: flex; justify-content: space-around; padding: 12px; z-index: 90; border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { color: #64748b; font-size: 1.5rem; }
        .nav-item.active { color: var(--primary); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header class="p-6 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-white/10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg"><span class="material-icons-round text-white">bolt</span></div>
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">SOCIO<span class="text-indigo-500">COMISION</span></h1>
                <p id="last-update-text" class="text-[9px] font-bold text-emerald-400 uppercase">Monitor Real-Time 2026</p>
            </div>
        </div>
        <span id="ping-static" class="w-3 h-3 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]"></span>
    </header>

    <main class="px-5 space-y-8 mt-4">
        <!-- KPIs -->
        <div class="grid grid-cols-3 gap-3">
            <div class="glass-panel p-4 text-center"><p class="text-[9px] font-black text-slate-500 uppercase">Base</p><p id="total-users" class="text-xl font-black">0</p></div>
            <div class="glass-panel p-4 text-center border-emerald-500/30"><p class="text-[9px] font-black text-emerald-500 uppercase">Sala</p><p id="active-users" class="text-xl font-black text-emerald-400">0</p></div>
            <div class="glass-panel p-4 text-center border-rose-500/30"><p class="text-[9px] font-black text-rose-500 uppercase">Bloq</p><p id="inactive-users" class="text-xl font-black text-rose-400">0</p></div>
        </div>

        <!-- Monitor Real Time -->
        <section id="seccion-live">
            <h2 class="text-[11px] font-black uppercase tracking-widest text-slate-500 mb-4 flex items-center gap-2"><span class="material-icons-round text-indigo-500 text-sm">sensors</span> Monitor Real-Time</h2>
            <div id="live-monitor-grid" class="flex gap-4 overflow-x-auto pb-2 no-scrollbar"></div>
        </section>

        <!-- Buscador -->
        <section id="seccion-db" class="space-y-4">
            <input type="text" id="searchInput" placeholder="Nombre o ID..." class="w-full bg-slate-900 border-2 border-slate-800 rounded-2xl py-4 px-6 text-sm text-white focus:border-indigo-500 outline-none shadow-xl">
            <div id="users-table-body" class="space-y-3"></div>
        </section>
    </main>

    <!-- Modal Principal -->
    <div id="userDetailsModal" class="modal-sheet">
        <div class="absolute inset-0" id="modal-overlay"></div>
        <div class="modal-content no-scrollbar">
            <div class="sticky top-0 bg-slate-900 p-6 border-b border-white/10 flex justify-between items-center z-50">
                <div>
                    <h3 id="modal-header-display" class="text-2xl font-black italic text-white leading-none">--</h3>
                    <p class="text-indigo-400 font-mono text-[10px] font-bold mt-1 uppercase">ID: <span id="modal-id">--</span></p>
                </div>
                <div class="flex gap-2">
                    <button id="toggleEditBtn" class="w-12 h-12 rounded-2xl bg-slate-800 text-white flex items-center justify-center shadow-lg"><i class="fas fa-edit"></i></button>
                    <button id="closeModalBtn" class="w-12 h-12 rounded-2xl bg-slate-800 text-rose-500 flex items-center justify-center shadow-lg"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="p-6 space-y-8">
                <button id="modal-status-toggle" class="w-full py-4 rounded-xl font-black text-[11px] uppercase shadow-md transition-all"></button>

                <div class="bg-gradient-to-br from-indigo-600 to-indigo-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-2">Puntos Disponibles</p>
                    <div class="flex items-center justify-between">
                        <span id="modal-puntos-display" class="text-6xl font-black tracking-tighter">0</span>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="w-11 h-11 rounded-xl bg-white/10 font-bold point-btn" data-val="-10">-10</button>
                            <button class="w-11 h-11 rounded-xl bg-white/10 font-bold point-btn" data-val="10">+10</button>
                            <button class="w-11 h-11 rounded-xl bg-white/10 font-bold point-btn" data-val="-1">-1</button>
                            <button class="w-11 h-11 rounded-xl bg-white text-indigo-900 font-black point-btn" data-val="1">+1</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div id="openSaldoModalBtn" class="bg-slate-900 p-5 rounded-3xl border border-white/5"><p class="label-style">Saldo Anterior</p><p id="modal-saldo-anterior" class="text-2xl font-mono font-black text-white">$0</p></div>
                    <div id="openAbsenceModalBtn" class="bg-slate-900 p-5 rounded-3xl border border-white/5"><p class="label-style text-rose-400">Ausencias</p><p id="modal-dias-ausencia" class="text-2xl font-mono font-black text-white">0 d</p></div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label-style">Nombre</label><input type="text" id="modal-nombre" class="editable-input" disabled></div>
                        <div><label class="label-style">Apellido</label><input type="text" id="modal-apellido" class="editable-input" disabled></div>
                    </div>
                    <div><label class="label-style">Teléfono</label><input type="text" id="modal-telefono" class="editable-input" disabled></div>
                    
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="label-style">Día</label><input type="number" id="modal-dia" class="editable-input text-center" disabled></div>
                        <div><label class="label-style">Mes</label><select id="modal-mes" class="editable-input" disabled><option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option><option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option><option value="Agosto">Agosto</option><option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option></select></div>
                        <div><label class="label-style">Año</label><input type="number" id="modal-anio" class="editable-input text-center" disabled></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label-style">Sección</label><select id="modal-seccion" class="editable-input" disabled><option value="General">General</option><option value="Mesas">Mesas</option><option value="Máquinas">Máquinas</option><option value="Bóveda">Bóveda</option><option value="TGM">TGM</option></select></div>
                        <div><label class="label-style">Contrato</label><input type="text" id="modal-contrato" class="editable-input" disabled></div>
                    </div>
                </div>

                <button id="saveChangesBtn" class="hidden w-full py-5 bg-emerald-600 text-white rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg">Confirmar Cambios en BD</button>
                
                <!-- Historial -->
                <div class="pt-6 border-t border-white/10">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Registros de Acceso</h4>
                        <span id="modal-total-visitas-badge" class="px-3 py-1 bg-indigo-500/10 rounded text-indigo-400 font-bold text-[10px]">Total: 0</span>
                    </div>
                    <ul id="modal-historial-lista" class="space-y-2 max-h-48 overflow-y-auto no-scrollbar text-[11px] font-mono"></ul>
                </div>

                <!-- ELIMINAR -->
                <button id="deleteUserBtn" class="w-full py-4 text-rose-500/40 font-bold text-[10px] uppercase tracking-widest border border-dashed border-rose-500/20 rounded-xl mt-4 active:bg-rose-600 active:text-white transition-all">
                    <i class="fas fa-trash-alt mr-2"></i> Eliminar Socio Definitivamente
                </button>
            </div>
        </div>
    </div>

    <!-- Modales Auxiliares -->
    <div id="saldoModal" class="hidden fixed inset-0 z-[120] bg-black/95 flex items-center justify-center p-10 backdrop-blur-md">
        <div class="glass-panel w-full max-w-xs p-8 space-y-6 text-center">
            <h3 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Ajustar Saldo</h3>
            <input type="number" id="saldoInput" class="w-full bg-transparent border-none text-5xl font-mono font-black text-center text-indigo-400 focus:ring-0">
            <div class="flex flex-col gap-2"><button id="saveSaldoBtn" class="w-full py-4 bg-emerald-500 text-white rounded-xl font-black uppercase text-xs">Guardar</button><button id="cancelSaldoBtn" class="w-full py-2 text-slate-500 font-bold uppercase text-[10px]">Cerrar</button></div>
        </div>
    </div>

    <div id="absenceModal" class="hidden fixed inset-0 z-[120] bg-black/95 flex items-end justify-center backdrop-blur-md">
        <div class="glass-panel w-full rounded-b-none p-6 pb-12 space-y-6">
            <div class="flex justify-between items-center text-white"><button id="prevMonthBtn" class="w-10 h-10 bg-slate-800 rounded-xl"><i class="fas fa-chevron-left"></i></button><h4 id="monthYear" class="font-black text-sm uppercase"></h4><button id="nextMonthBtn" class="w-10 h-10 bg-slate-800 rounded-xl"><i class="fas fa-chevron-right"></i></button></div>
            <div id="calendar-container" class="grid grid-cols-7 gap-1"></div>
            <div class="flex flex-col gap-2"><button id="saveAbsenceBtn" class="w-full py-4 bg-rose-500 text-white rounded-2xl font-black uppercase text-xs">Guardar Faltas</button><button id="cancelAbsenceBtn" class="w-full py-2 text-slate-500 font-bold text-[10px] uppercase">Cerrar</button></div>
        </div>
    </div>

    <nav class="nav-dock">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="nav-item active"><span class="material-icons-round">home</span></button>
        <a href="#seccion-live" class="nav-item"><span class="material-icons-round">bolt</span></a>
        <a href="#seccion-db" class="nav-item"><span class="material-icons-round">search</span></a>
    </nav>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCs74u0wnowFhgAbYM_EL11eEyOH4GivGzwg1v0ovMLW6QvwqOuL9HRhxmAwL9m8X6/exec';
        let state = { users: [], previousActiveIds: null, isFetching: false, currentUser: null, isEditing: false, calendarDate: new Date() };

        const ui = {
            toastContainer: document.getElementById('toast-container'),
            liveGrid: document.getElementById('live-monitor-grid'),
            tableBody: document.getElementById('users-table-body'),
            searchInput: document.getElementById('searchInput'),
            counters: { total: document.getElementById('total-users'), active: document.getElementById('active-users'), inactive: document.getElementById('inactive-users') },
            modal: { 
                el: document.getElementById('userDetailsModal'), header: document.getElementById('modal-header-display'), id: document.getElementById('modal-id'),
                statusBtn: document.getElementById('modal-status-toggle'), nombre: document.getElementById('modal-nombre'), apellido: document.getElementById('modal-apellido'),
                phone: document.getElementById('modal-telefono'), section: document.getElementById('modal-seccion'), contract: document.getElementById('modal-contrato'),
                dia: document.getElementById('modal-dia'), mes: document.getElementById('modal-mes'), anio: document.getElementById('modal-anio'),
                puntos: document.getElementById('modal-puntos-display'), saldo: document.getElementById('modal-saldo-anterior'), ausencias: document.getElementById('modal-dias-ausencia'),
                history: document.getElementById('modal-historial-lista'), editBtn: document.getElementById('toggleEditBtn'), saveBtn: document.getElementById('saveChangesBtn'), 
                closeBtn: document.getElementById('closeModalBtn'), deleteBtn: document.getElementById('deleteUserBtn'), badge: document.getElementById('modal-total-visitas-badge')
            },
            saldoModal: { el: document.getElementById('saldoModal'), input: document.getElementById('saldoInput'), saveBtn: document.getElementById('saveSaldoBtn') },
            absenceModal: { el: document.getElementById('absenceModal'), calendarContainer: document.getElementById('calendar-container'), monthYear: document.getElementById('monthYear'), prevBtn: document.getElementById('prevMonthBtn'), nextBtn: document.getElementById('nextMonthBtn'), saveBtn: document.getElementById('saveAbsenceBtn') }
        };

        const safe = str => str ? String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])) : '';
        const parseDate = d => { const i = new Date(d); return isNaN(i) ? null : i; };
        const normalizarFecha = f => { if(!f)return null; const d=new Date(f); return isNaN(d.getTime())?f:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };

        const showToast = (user, type) => {
            if(!user) return;
            const t = document.createElement('div');
            t.className = `toast border-l-4 ${type === 'connect' ? 'border-emerald-500' : 'border-amber-500'}`;
            t.innerHTML = `<span class="material-icons-round ${type === 'connect' ? 'text-emerald-400' : 'text-amber-400'}">${type === 'connect' ? 'login' : 'logout'}</span>
                           <div><p class="text-[9px] font-black uppercase opacity-60">SocioFlow Update</p>
                           <p class="text-xs font-bold text-white">${safe(user.Nombre)} ${type === 'connect' ? 'INGRESÓ' : 'SALIÓ'}</p></div>`;
            ui.toastContainer.appendChild(t);
            setTimeout(() => { t.classList.add('hide'); setTimeout(() => t.remove(), 500); }, 4500);
        };

        // LÓGICA DE HORA CORRECTA
        const getLatestSocioTime = (u) => {
            const allDates = [parseDate(u.Timestamp)];
            if (u.Historial && Array.isArray(u.Historial)) {
                u.Historial.forEach(h => { const d = parseDate(h); if (d) allDates.push(d); });
            }
            const sorted = allDates.filter(d => d !== null).sort((a, b) => b - a);
            return sorted.length > 0 ? sorted[0] : new Date();
        };

        const fetchData = async () => {
            if(state.isFetching) return;
            state.isFetching = true;
            try {
                const response = await fetch(SCRIPT_URL + '?action=read&v=' + Date.now());
                const data = await response.json();
                state.users = data.filter(u => u["ID de Usuario"]).sort((a,b) => parseDate(b.Timestamp) - parseDate(a.Timestamp));
                
                const currentActiveIds = state.users.filter(u => u.Estado === 'Activo').map(u => u['ID de Usuario']);
                if (state.previousActiveIds !== null) {
                    currentActiveIds.forEach(id => { if (!state.previousActiveIds.includes(id)) showToast(state.users.find(x => x['ID de Usuario'] === id), 'connect'); });
                    state.previousActiveIds.forEach(id => { if (!currentActiveIds.includes(id)) showToast(state.users.find(x => x['ID de Usuario'] === id) || {Nombre:'ID: '+id}, 'disconnect'); });
                }
                state.previousActiveIds = currentActiveIds;

                renderAll();
                if (ui.modal.el.classList.contains('open') && state.currentUser) {
                    const u = state.users.find(x => x['ID de Usuario'] === state.currentUser['ID de Usuario']);
                    if(u) refreshModalHistory(u);
                }
            } catch(e) { console.error(e); } finally { state.isFetching = false; }
        };

        const renderAll = () => {
            ui.counters.total.textContent = state.users.length;
            ui.counters.active.textContent = state.users.filter(u => u.Estado === 'Activo').length;
            ui.counters.inactive.textContent = state.users.filter(u => u.Estado === 'Inactivo').length;

            ui.liveGrid.innerHTML = state.users.filter(u => u.Estado === 'Activo').map(u => {
                const latestDate = getLatestSocioTime(u);
                const timeStr = latestDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const visitas = u.Historial?.length || 0;
                
                return `<div class="glass-panel p-4 min-w-[125px] text-center relative active:scale-95 transition-transform" onclick="openModalById('${u['ID de Usuario']}')">
                            <button class="btn-kick absolute top-1 right-1 text-slate-600" data-id="${u['ID de Usuario']}"><span class="material-icons-round text-sm">cancel</span></button>
                            <div class="w-12 h-12 bg-indigo-500/20 rounded-full flex items-center justify-center font-black text-indigo-400 mx-auto mb-2 border border-indigo-500/30">${u.Nombre[0]}${u.Apellido[0]}</div>
                            <p class="font-bold text-[10px] text-white truncate">${safe(u.Nombre)}</p>
                            <p class="text-[9px] text-emerald-500 font-mono font-bold mt-1">${timeStr}</p>
                            <span class="text-[8px] bg-indigo-500/10 text-indigo-300 px-1 rounded mt-1 inline-block uppercase font-black">${visitas} VISITAS</span>
                        </div>`;
            }).join('');
            document.querySelectorAll('.btn-kick').forEach(b => b.onclick = e => { e.stopPropagation(); kickUser(b); });
            renderList();
        };

        const renderList = () => {
            const search = ui.searchInput.value.toLowerCase();
            const filtered = state.users.filter(u => (u.Nombre + u.Apellido + u['ID de Usuario']).toLowerCase().includes(search));
            ui.tableBody.innerHTML = filtered.map(u => {
                const blocked = u.Estado === 'Inactivo';
                const visitas = u.Historial?.length || 0;
                return `<div class="glass-panel p-5 flex justify-between items-center active:bg-slate-800 transition-colors" onclick="openModalById('${u['ID de Usuario']}')">
                            <div><p class="font-bold text-sm text-white">${safe(u.Nombre)} ${safe(u.Apellido)}</p>
                            <p class="text-[10px] text-slate-500 font-mono mt-1">ID: ${u['ID de Usuario']} • <span class="text-indigo-400 font-bold">Año: ${u['Año de Ingreso'] || '2026'}</span> • <span class="text-indigo-300">${visitas} Visitas</span></p></div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${blocked?'bg-rose-500/10 text-rose-500':'bg-emerald-500/10 text-emerald-500'}"><span class="material-icons-round text-lg">${blocked?'lock':'check_circle'}</span></div>
                        </div>`;
            }).join('');
        };

        const refreshModalHistory = (u) => {
            const sortedHistory = [...(u.Historial || [])].map(h => parseDate(h)).filter(d => d !== null).sort((a, b) => b - a);
            ui.modal.badge.textContent = `Total: ${sortedHistory.length}`;
            ui.modal.history.innerHTML = sortedHistory.slice(0, 20).map(d => `<li class="flex justify-between py-2 border-b border-white/5 text-[11px] text-white font-bold"><span>${d.toLocaleDateString('es-CL')}</span><span class="text-indigo-400 font-black">${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} HRS</span></li>`).join('');
        };

        window.openModalById = id => {
            const u = state.users.find(x => x['ID de Usuario'] == id);
            if(!u) return;
            state.currentUser = u; state.isEditing = false;
            const m = ui.modal;
            m.header.textContent = `${u.Nombre} ${u.Apellido}`; m.id.textContent = u['ID de Usuario'];
            m.nombre.value = u.Nombre || ''; m.apellido.value = u.Apellido || ''; m.phone.value = u.Teléfono || '';
            m.section.value = u.Sección || 'General'; m.contract.value = u['Tipo de Contrato'] || '';
            m.dia.value = u['Día de Ingreso'] || ''; m.mes.value = u['Mes de Ingreso'] || 'Enero'; m.anio.value = u['Año de Ingreso'] || '';
            m.puntos.textContent = u.Puntos || 0; m.saldo.textContent = `$${(u.SaldoAnterior||0).toLocaleString('es-CL')}`; 
            m.ausencias.textContent = `${u.DiasAusencia?.length||0} d`;

            const isBlocked = u.Estado === 'Inactivo';
            m.statusBtn.className = isBlocked ? 'w-full py-4 rounded-xl font-black text-[11px] bg-rose-600 text-white shadow-lg' : 'w-full py-4 rounded-xl font-black text-[11px] bg-emerald-600 text-white shadow-lg';
            m.statusBtn.textContent = isBlocked ? 'DESBLOQUEAR SOCIO' : 'BLOQUEAR SOCIO';
            m.statusBtn.onclick = async () => {
                m.statusBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: u['ID de Usuario'], status: isBlocked ? 'Activo' : 'Inactivo' }) });
                fetchData(); setTimeout(() => openModalById(u['ID de Usuario']), 500);
            };

            refreshModalHistory(u);
            updateEditModeUI();
            m.el.classList.add('open');
        };

        const updateEditModeUI = () => {
            const fields = [ui.modal.nombre, ui.modal.apellido, ui.modal.phone, ui.modal.section, ui.modal.contract, ui.modal.dia, ui.modal.mes, ui.modal.anio];
            fields.forEach(f => f.disabled = !state.isEditing);
            ui.modal.saveBtn.classList.toggle('hidden', !state.isEditing);
            ui.modal.editBtn.className = state.isEditing ? 'w-12 h-12 rounded-2xl bg-indigo-600 text-white flex items-center justify-center' : 'w-12 h-12 rounded-2xl bg-slate-800 text-white flex items-center justify-center';
        };

        ui.modal.editBtn.onclick = () => { state.isEditing = !state.isEditing; updateEditModeUI(); };
        ui.modal.closeBtn.onclick = () => ui.modal.el.classList.remove('open');
        ui.modal.saveBtn.onclick = async () => {
            ui.modal.saveBtn.textContent = 'PROCESANDO...';
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'editUser', id: state.currentUser['ID de Usuario'], nombre: ui.modal.nombre.value, apellido: ui.modal.apellido.value, telefono: ui.modal.phone.value, seccion: ui.modal.section.value, contrato: ui.modal.contract.value, dia: ui.modal.dia.value, mes: ui.modal.mes.value, anio: ui.modal.anio.value }) });
            state.isEditing = false; updateEditModeUI(); fetchData(); ui.modal.saveBtn.textContent = 'Confirmar Cambios en BD';
        };

        ui.modal.deleteBtn.onclick = async () => {
            if (confirm(`¿ELIMINAR A ${state.currentUser.Nombre.toUpperCase()} DEFINITIVAMENTE?`)) {
                ui.modal.deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ELIMINANDO...';
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteUser', id: state.currentUser['ID de Usuario'] }) });
                ui.modal.el.classList.remove('open');
                fetchData();
            }
        };

        document.querySelectorAll('.point-btn').forEach(b => b.onclick = async () => {
            const val = parseInt(b.dataset.val); ui.modal.puntos.textContent = parseInt(ui.modal.puntos.textContent) + val;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: state.currentUser['ID de Usuario'], amount: val }) });
        });

        const kickUser = async btn => {
            if(!confirm("¿CONFIRMAR KICK?")) return;
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: btn.dataset.id, status: 'KICK' }) });
            fetchData();
        };

        function renderCalendar() {
            const y=state.calendarDate.getFullYear(), m=state.calendarDate.getMonth();
            ui.absenceModal.monthYear.textContent = `${["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"][m]} ${y}`;
            const first=new Date(y,m,1).getDay(), last=new Date(y,m+1,0).getDate(), start=(first+6)%7;
            const marked = new Set((state.currentUser.DiasAusencia||[]).map(normalizarFecha));
            let h=''; for(let i=0;i<start;i++)h+='<div></div>';
            for(let i=1;i<=last;i++){ const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; h+=`<div class="aspect-square flex items-center justify-center rounded-lg text-xs font-bold ${marked.has(ds)?'bg-rose-500 text-white':'bg-slate-800'}" data-date="${ds}">${i}</div>`; }
            ui.absenceModal.calendarContainer.innerHTML = h;
            ui.absenceModal.calendarContainer.querySelectorAll('div[data-date]').forEach(d => d.onclick = () => d.classList.toggle('bg-rose-500'));
        }

        ui.absenceModal.prevBtn.onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); };
        ui.absenceModal.nextBtn.onclick = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); };
        ui.absenceModal.saveBtn.onclick = async () => {
             const dates = Array.from(ui.absenceModal.calendarContainer.querySelectorAll('.bg-rose-500')).map(d => d.dataset.date);
             await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateAbsences', id: state.currentUser['ID de Usuario'], dates }) });
             ui.modal.ausencias.textContent = `${dates.length} d`; document.getElementById('absenceModal').classList.add('hidden');
        };
        
        document.getElementById('openSaldoModalBtn').onclick = () => { document.getElementById('saldoInput').value = state.currentUser.SaldoAnterior||0; document.getElementById('saldoModal').classList.remove('hidden'); };
        document.getElementById('saveSaldoBtn').onclick = async () => { 
            const amount = parseFloat(document.getElementById('saldoInput').value);
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateSaldo', id: state.currentUser['ID de Usuario'], amount }) });
            ui.modal.saldo.textContent = `$${amount.toLocaleString('es-CL')}`; document.getElementById('saldoModal').classList.add('hidden');
        };
        document.getElementById('cancelSaldoBtn').onclick = () => document.getElementById('saldoModal').classList.add('hidden');
        document.getElementById('openAbsenceModalBtn').onclick = () => { state.calendarDate = new Date(); renderCalendar(); document.getElementById('absenceModal').classList.remove('hidden'); };
        document.getElementById('cancelAbsenceBtn').onclick = () => document.getElementById('absenceModal').classList.add('hidden');
        document.getElementById('modal-overlay').onclick = () => ui.modal.el.classList.remove('open');
        ui.modal.closeBtn.onclick = () => ui.modal.el.classList.remove('open');

        ui.searchInput.oninput = renderList;
        fetchData(); setInterval(fetchData, 4500);
    });
    </script>
</body>
</html>